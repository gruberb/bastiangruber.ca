<!doctype html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><link rel="canonical" href="https://bastiangruber.ca/posts/how-i-built-a-minimal-knowledge-sync-for-workledger/"><link rel="alternate" type="application/rss+xml" href="/feed.xml" title="Feed"><link href="/assets/main.82dfb52291408f8148f6.css" rel="stylesheet"><link rel="preconnect" href="https://fonts.gstatic.com"><link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@300;400;500;600;700&family=IBM+Plex+Mono:wght@300;400;500;600&display=swap" rel="stylesheet"><link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500;700&display=swap" rel="stylesheet"><title>How I built a minimal-knowledge sync for WorkLedger</title><link rel="icon" type="image/png" href="/images/favicons/favicon-96x96.png" sizes="96x96"><link rel="icon" type="image/svg+xml" href="/images/favicons/favicon.svg"><link rel="shortcut icon" href="/images/favicons/favicon.ico"><link rel="apple-touch-icon" sizes="180x180" href="/images/favicons/apple-touch-icon.png"><link rel="manifest" href="/images/favicons/site.webmanifest"><link rel="me" href="https://hachyderm.io/@bastian"><script defer="defer" data-domain="bastiangruber.ca" src="https://analytics.novanexus.ca/js/script.js"></script><meta property="og:title" content="How I built a minimal-knowledge sync for WorkLedger"><meta property="og:site_name" content="Bastian Gruber"><meta property="og:type" content="website"><meta property="og:url" content="https://bastiangruber.ca/posts/how-i-built-a-minimal-knowledge-sync-for-workledger/"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:creator" content="@recvonline"><meta name="description" content="Sync between devices without any account creation and entering any email or password."><meta property="og:description" content="Sync between devices without any account creation and entering any email or password."><meta name="description" content="Sync between devices without any account creation and entering any email or password."><meta property="og:image" content="https://bastiangruber.ca/images/default-social-image.png"><meta name="twitter:image" content="https://bastiangruber.ca/images/default-social-image.png"><script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script><script>mermaid.initialize({startOnLoad:true});</script></head><body class="post-page"><div class="reading-progress"><div class="reading-progress-bar" id="reading-progress-bar"></div></div><div class="layout-wrapper"><header class="header"><div class="header__content"><h1 class="site-title"><a href="/">Bastian Gruber</a></h1><nav class="nav desktop-nav"><ul class="nav__list"><li class="nav-item"><a href="/blog/">Blog</a></li><li class="nav-item"><a href="/talks">Talks &amp; Interviews</a></li><li class="nav-item"><a href="/projects">Side Projects</a></li><li class="nav-item"><a href="/about">About</a></li></ul></nav><button class="mobile-menu-btn" id="mobileMenuBtn" aria-label="Toggle mobile menu"><span class="hamburger-line"></span> <span class="hamburger-line"></span> <span class="hamburger-line"></span></button><nav class="mobile-nav" id="mobileNav"><div class="mobile-nav-close" id="mobileNavClose"></div><ul class="mobile-nav__list"><li class="mobile-nav-item"><a href="/blog/">Blog</a></li><li class="mobile-nav-item"><a href="/talks">Talks &amp; Interviews</a></li><li class="mobile-nav-item"><a href="/projects">Side Projects</a></li><li class="mobile-nav-item"><a href="/about">About</a></li></ul></nav></div></header><main class="main"><article class="post"><header class="post__header"><h1>How I built a minimal-knowledge sync for WorkLedger</h1><div class="post__details"><time datetime="2026-02-20">20 Feb 2026 </time><span>| </span><span>9 min read</span></div></header><main class="post__content"><h2>A local-first digital notebook</h2><p>A bit more than a week ago, I came across the blog post <a href="https://ntietz.com/blog/using-an-engineering-notebook/">Using an engineering notebook</a>. I personally love notebooks and use... too many of them. My only issue has always been that when my brain is on fire, my handwriting is not neat enough, it's not structured enough, and it helps me to note things down, but it always feels like I could be faster by text-to-speech or keyboard typing.</p><p>Now there are moments of silence of course, when I can sit down with a cup of coffee and map out a feature or thought in my head. For that, I don't think any digital device will ever come close to simple pen and paper.</p><p>Nevertheless, the time was ripe to &quot;Build it yourself&quot;. I am always inspired by <a href="https://excalidraw.com/">Excalidraw</a>. I can open it, don't need an account, draw to my heart's content, and then save the finished drawing as a PNG to my local hard drive and take it anywhere. I wanted to build something seamless like that for writing. Hence, <a href="https://workledger.org/">WorkLedger was born</a>.</p><blockquote><p>The <a href="" target="_blank">landing page</a> gives you a nice feature overview.</p></blockquote><blockquote><p>Shout out to <a href="https://www.blocknotejs.org/">BlockNote</a> for offering a superb text editing experience.</p></blockquote><p>I thought to myself: Local first is great, I will never need sync. Until I left the house on a Friday to bring my kids to skating lessons, work still ruminating within me, and I thought: Let's get this down on &quot;paper&quot; so I don't forget my thoughts. I opened WorkLedger on my iPhone and saw - nothing. Obviously a new session means new data. Argh. I had to implement sync.</p><div class="sidecar">A note: I am not a security expert. If you find issues or concerns with this workflow, feel free to email me at foreach [at] me dot com.</div><h2>The birth of sync ID</h2><p>I started using <a href="https://mullvad.net/en">Mullvad VPN</a> this past year and was utterly confused by their lack of... account? I couldn't find a deep dive into this, all I have as an explanation is <a href="https://mullvad.net/en/blog/mullvads-account-numbers-get-longer-and-safer">this blog post</a> from 2017.</p><p>I got inspired though: What if I had a button which can generate a sync ID, and with that, I can - sync? That's it. No password, no complicated setup. And I want to copy/paste this sync ID to my devices where I need it. And <em>somehow</em>, the server doesn't even know this id, but still can give me my associated entries.</p><h3>The core trick: domain separation</h3><p>The core question is: If the server never sees this magic id, how does it know which entries belong to me?</p><p>The answer is that one string becomes two different strings through a one-way process. Given a sync ID like <code>wl-a1b2c3d4e5f6a7b8c9d0</code>, I derive two separate values from it:</p><p><img src="/images/domain_separation.png" alt="Domain separation"></p><p>This is called <a href="https://github.com/SalusaSecondus/CryptoGotchas/blob/master//domain_separation.md">domain separation</a>. The prefixes <code>auth</code> and <code>crypto</code> ensure the two hashes are computationally unrelated — knowing one reveals nothing useful about the other.</p><p>The <code>auth</code> token goes to the server as an <code>X-Auth-Token</code> header. The server uses it to identify your account and look up your entries. But because it is a SHA-256 hash of a sync ID (not the sync ID itself), the server cannot reverse it. And because the crypto seed uses a different prefix, the server cannot derive the encryption key either.</p><p>This is how it looks in my <code>crypto.ts</code> file:</p><div class="code-block-container"><button class="copy-code-button" aria-label="Copy snippet"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg></button><pre class="language-typescript"><code class="language-typescript"><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">sha256Hex</span><span class="token punctuation">(</span>input<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token operator">></span> <span class="token punctuation">{</span><br>  <span class="token keyword">const</span> encoded <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TextEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span>input<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">const</span> hash <span class="token operator">=</span> <span class="token keyword">await</span> crypto<span class="token punctuation">.</span>subtle<span class="token punctuation">.</span><span class="token function">digest</span><span class="token punctuation">(</span><span class="token string">"SHA-256"</span><span class="token punctuation">,</span> encoded<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">return</span> <span class="token builtin">Array</span><span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Uint8Array</span><span class="token punctuation">(</span>hash<span class="token punctuation">)</span><span class="token punctuation">)</span><br>    <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span> <span class="token operator">=></span> b<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">padStart</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">"0"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br>    <span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><br><br><span class="token keyword">export</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">computeAuthToken</span><span class="token punctuation">(</span>syncId<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token operator">></span> <span class="token punctuation">{</span><br>  <span class="token keyword">return</span> <span class="token function">sha256Hex</span><span class="token punctuation">(</span><span class="token string">"auth:"</span> <span class="token operator">+</span> syncId<span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><br><br><span class="token keyword">export</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">computeCryptoSeed</span><span class="token punctuation">(</span>syncId<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token operator">></span> <span class="token punctuation">{</span><br>  <span class="token keyword">return</span> <span class="token function">sha256Hex</span><span class="token punctuation">(</span><span class="token string">"crypto:"</span> <span class="token operator">+</span> syncId<span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre></div><p>The <code>sha256Hex</code> function uses the Web Crypto API, which is available in all modern browsers, so I don't even need to import any npm modules for it.</p><h2>Generating the sync ID</h2><p>The sync ID is generated client-side from 10 random bytes, giving 80 bits of entropy.</p><blockquote><p>A byte can hold any value from 0 to 255 — that is 256 possibilities. Since each bit doubles the possibilities and 2⁸ = 256, one byte equals 8 bits of entropy. Ten random bytes means 10 × 8 = 80 bits.</p></blockquote><p>For reference:</p><ul><li>A typical password might have 30-50 bits of entropy (guessable)</li><li>80 bits is in the &quot;nation-state can't brute-force this&quot; range</li><li>128 bits is the standard target for symmetric cryptography</li></ul><div class="code-block-container"><button class="copy-code-button" aria-label="Copy snippet"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg></button><pre class="language-typescript"><code class="language-typescript"><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">generateSyncIdLocal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">string</span> <span class="token punctuation">{</span><br>  <span class="token keyword">const</span> bytes <span class="token operator">=</span> crypto<span class="token punctuation">.</span><span class="token function">getRandomValues</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Uint8Array</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">const</span> hex <span class="token operator">=</span> <span class="token builtin">Array</span><span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>bytes<span class="token punctuation">)</span><br>    <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span> <span class="token operator">=></span> b<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">padStart</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">"0"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br>    <span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">wl-</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>hex<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre></div><p>The result looks like <code>wl-a1b2c3d4e5f6a7b8c9d0</code>. The <code>wl-</code> prefix is cosmetic - it makes the string recognizable as a WorkLedger sync ID when you paste it between devices.</p><p>80 bits of randomness means there are roughly 1.2 × 10²⁴ possible sync IDs. For any realistic number of users — say, 10 million accounts — the probability of a collision is vanishingly small.</p><h3>From crypto seed to encryption key</h3><p>The crypto seed alone is not the encryption key. It goes through one more transformation: <a href="https://www.ssltrust.ca/blog/pbkdf2-password-key-derivation">PBKDF2 key derivation</a> with a server-provided salt.</p><p>When you create an account, the server generates 16 random bytes as your salt and sends it back. This salt is stored alongside your auth token in the server database. Every device that connects with the same sync ID gets the same salt, which means every device derives the same encryption key.</p><div class="code-block-container"><button class="copy-code-button" aria-label="Copy snippet"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg></button><pre class="language-typescript"><code class="language-typescript"><span class="token keyword">const</span> <span class="token constant">PBKDF2_ITERATIONS</span> <span class="token operator">=</span> <span class="token number">100_000</span><span class="token punctuation">;</span><br><br><span class="token keyword">export</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">deriveKey</span><span class="token punctuation">(</span>syncId<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> saltBase64<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span>CryptoKey<span class="token operator">></span> <span class="token punctuation">{</span><br>  <span class="token keyword">const</span> cryptoSeed <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">computeCryptoSeed</span><span class="token punctuation">(</span>syncId<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">const</span> encoder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TextEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">const</span> salt <span class="token operator">=</span> Uint8Array<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token function">atob</span><span class="token punctuation">(</span>saltBase64<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>c<span class="token punctuation">)</span> <span class="token operator">=></span> c<span class="token punctuation">.</span><span class="token function">charCodeAt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>  <span class="token keyword">const</span> keyMaterial <span class="token operator">=</span> <span class="token keyword">await</span> crypto<span class="token punctuation">.</span>subtle<span class="token punctuation">.</span><span class="token function">importKey</span><span class="token punctuation">(</span><br>    <span class="token string">"raw"</span><span class="token punctuation">,</span><br>    encoder<span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span>cryptoSeed<span class="token punctuation">)</span><span class="token punctuation">,</span><br>    <span class="token string">"PBKDF2"</span><span class="token punctuation">,</span><br>    <span class="token boolean">false</span><span class="token punctuation">,</span><br>    <span class="token punctuation">[</span><span class="token string">"deriveKey"</span><span class="token punctuation">]</span><span class="token punctuation">,</span><br>  <span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>  <span class="token keyword">return</span> crypto<span class="token punctuation">.</span>subtle<span class="token punctuation">.</span><span class="token function">deriveKey</span><span class="token punctuation">(</span><br>    <span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">"PBKDF2"</span><span class="token punctuation">,</span> salt<span class="token punctuation">,</span> iterations<span class="token operator">:</span> <span class="token constant">PBKDF2_ITERATIONS</span><span class="token punctuation">,</span> hash<span class="token operator">:</span> <span class="token string">"SHA-256"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span><br>    keyMaterial<span class="token punctuation">,</span><br>    <span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">"AES-GCM"</span><span class="token punctuation">,</span> length<span class="token operator">:</span> <span class="token number">256</span> <span class="token punctuation">}</span><span class="token punctuation">,</span><br>    <span class="token boolean">false</span><span class="token punctuation">,</span><br>    <span class="token punctuation">[</span><span class="token string">"encrypt"</span><span class="token punctuation">,</span> <span class="token string">"decrypt"</span><span class="token punctuation">]</span><span class="token punctuation">,</span><br>  <span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre></div><p>The output is an AES-256-GCM key - a symmetric key that both encrypts and decrypts. PBKDF2 with 100,000 iterations makes brute-force attacks against weak sync IDs expensive, though with 80 bits of entropy the sync ID itself is already computationally infeasible to guess.</p><p>The full derivation chain looks like this:</p><p><img src="/images/derive_aes_key.png" alt="Deriving the AES key"></p><h3>Encrypting entries</h3><p>With the key derived, each notebook entry gets encrypted before it leaves the device. I split each entry into two parts: the content payload that gets encrypted, and minimal metadata that stays in plaintext.</p><div class="code-block-container"><button class="copy-code-button" aria-label="Copy snippet"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg></button><pre class="language-typescript"><code class="language-typescript"><span class="token keyword">export</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">encryptEntry</span><span class="token punctuation">(</span>key<span class="token operator">:</span> CryptoKey<span class="token punctuation">,</span> entry<span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span>SyncEntry<span class="token operator">></span> <span class="token punctuation">{</span><br>  <span class="token keyword">const</span> payload <span class="token operator">=</span> <span class="token punctuation">{</span><br>    dayKey<span class="token operator">:</span> entry<span class="token punctuation">.</span>dayKey<span class="token punctuation">,</span><br>    createdAt<span class="token operator">:</span> entry<span class="token punctuation">.</span>createdAt<span class="token punctuation">,</span><br>    updatedAt<span class="token operator">:</span> entry<span class="token punctuation">.</span>updatedAt<span class="token punctuation">,</span><br>    blocks<span class="token operator">:</span> entry<span class="token punctuation">.</span>blocks<span class="token punctuation">,</span><br>    isArchived<span class="token operator">:</span> entry<span class="token punctuation">.</span>isArchived<span class="token punctuation">,</span><br>    tags<span class="token operator">:</span> entry<span class="token punctuation">.</span>tags <span class="token operator">??</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span><br>    isPinned<span class="token operator">:</span> entry<span class="token punctuation">.</span>isPinned <span class="token operator">??</span> <span class="token boolean">false</span><span class="token punctuation">,</span><br>    signifier<span class="token operator">:</span> entry<span class="token punctuation">.</span>signifier<span class="token punctuation">,</span><br>  <span class="token punctuation">}</span><span class="token punctuation">;</span><br>  <span class="token keyword">const</span> plaintext <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>payload<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">const</span> encryptedPayload <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">encrypt</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> plaintext<span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>  <span class="token keyword">return</span> <span class="token punctuation">{</span><br>    id<span class="token operator">:</span> entry<span class="token punctuation">.</span>id<span class="token punctuation">,</span>                    <span class="token comment">// plaintext — server needs for dedup</span><br>    updatedAt<span class="token operator">:</span> entry<span class="token punctuation">.</span>updatedAt<span class="token punctuation">,</span>      <span class="token comment">// plaintext — server needs for conflict resolution</span><br>    isArchived<span class="token operator">:</span> entry<span class="token punctuation">.</span>isArchived<span class="token punctuation">,</span>    <span class="token comment">// plaintext — server needs for filtering</span><br>    isDeleted<span class="token operator">:</span> entry<span class="token punctuation">.</span>isDeleted<span class="token punctuation">,</span>      <span class="token comment">// plaintext — server needs for deletion markers</span><br>    encryptedPayload<span class="token punctuation">,</span>                <span class="token comment">// opaque blob</span><br>  <span class="token punctuation">}</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre></div><p>The content fields — your actual writing (<code>blocks</code>), your tags, your date organization (<code>dayKey</code>) — all go into the encrypted blob. The server gets only an opaque base64 string.</p><p>The metadata fields stay in plaintext because the server needs them for operational purposes: <code>id</code> for deduplication, <code>updatedAt</code> for last-write-wins conflict resolution, <code>isDeleted</code> for soft-delete markers.</p><p>The encryption itself uses AES-256-GCM with a random 12-byte initialization vector (IV) prepended to the ciphertext:</p><div class="code-block-container"><button class="copy-code-button" aria-label="Copy snippet"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg></button><pre class="language-typescript"><code class="language-typescript"><span class="token keyword">export</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">encrypt</span><span class="token punctuation">(</span>key<span class="token operator">:</span> CryptoKey<span class="token punctuation">,</span> plaintext<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token operator">></span> <span class="token punctuation">{</span><br>  <span class="token keyword">const</span> encoder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TextEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">const</span> iv <span class="token operator">=</span> crypto<span class="token punctuation">.</span><span class="token function">getRandomValues</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Uint8Array</span><span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">const</span> ciphertext <span class="token operator">=</span> <span class="token keyword">await</span> crypto<span class="token punctuation">.</span>subtle<span class="token punctuation">.</span><span class="token function">encrypt</span><span class="token punctuation">(</span><br>    <span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">"AES-GCM"</span><span class="token punctuation">,</span> iv <span class="token punctuation">}</span><span class="token punctuation">,</span><br>    key<span class="token punctuation">,</span><br>    encoder<span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span>plaintext<span class="token punctuation">)</span><span class="token punctuation">,</span><br>  <span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>  <span class="token keyword">const</span> combined <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Uint8Array</span><span class="token punctuation">(</span>iv<span class="token punctuation">.</span>byteLength <span class="token operator">+</span> ciphertext<span class="token punctuation">.</span>byteLength<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  combined<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>iv<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  combined<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Uint8Array</span><span class="token punctuation">(</span>ciphertext<span class="token punctuation">)</span><span class="token punctuation">,</span> iv<span class="token punctuation">.</span>byteLength<span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>  <span class="token keyword">let</span> binary <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span><br>  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> combined<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    binary <span class="token operator">+=</span> String<span class="token punctuation">.</span><span class="token function">fromCharCode</span><span class="token punctuation">(</span>combined<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br>  <span class="token keyword">return</span> <span class="token function">btoa</span><span class="token punctuation">(</span>binary<span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre></div><p>The loop builds the binary string one character at a time instead of using <code>String.fromCharCode(...combined)</code> with a spread operator — spreading passes every byte as a separate function argument, which blows the call stack for entries larger than ~64KB.</p><p>AES-GCM is an authenticated encryption scheme. It provides not only confidentiality but also integrity — if anyone tampers with the ciphertext, decryption fails. This matters because the server could theoretically modify the encrypted blobs, and AES-GCM ensures you would detect it. Note that AES-GCM only authenticates the encrypted payload itself — the plaintext metadata fields (<code>id</code>, <code>updatedAt</code>, etc.) travel outside the encryption envelope and are not integrity-protected.</p><p>A fresh random IV for every encryption operation means that encrypting the same entry twice produces different ciphertext, preventing identical content from producing identical blobs across pushes.</p><h2>The server: what it stores, what it cannot see</h2><p>The <a href="https://github.com/gruberb/workledger-sync">workledger-sync server</a> is a Rust service built with <a href="https://github.com/tokio-rs/axum">Axum</a> and SQLite. Its database schema is minimal:</p><div class="code-block-container"><button class="copy-code-button" aria-label="Copy snippet"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg></button><pre class="language-sql"><code class="language-sql"><span class="token comment">-- The sync_id column stores the auth token, NOT the raw sync ID.</span><br><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> accounts <span class="token punctuation">(</span><br>    sync_id       <span class="token keyword">TEXT</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span><span class="token punctuation">,</span>   <span class="token comment">-- auth token: SHA-256("auth:" + syncId)</span><br>    salt          <span class="token keyword">BLOB</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>      <span class="token comment">-- 16 random bytes, returned to client</span><br>    created_at    <span class="token keyword">INTEGER</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span><br>    last_seen_at  <span class="token keyword">INTEGER</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span><br>    entry_count   <span class="token keyword">INTEGER</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token number">0</span><br><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> entries <span class="token punctuation">(</span><br>    id                <span class="token keyword">TEXT</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span><br>    sync_id           <span class="token keyword">TEXT</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">REFERENCES</span> accounts<span class="token punctuation">(</span>sync_id<span class="token punctuation">)</span> <span class="token keyword">ON</span> <span class="token keyword">DELETE</span> <span class="token keyword">CASCADE</span><span class="token punctuation">,</span><br>    updated_at        <span class="token keyword">INTEGER</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span><br>    is_archived       <span class="token keyword">INTEGER</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token number">0</span><span class="token punctuation">,</span><br>    is_deleted        <span class="token keyword">INTEGER</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token number">0</span><span class="token punctuation">,</span><br>    encrypted_payload <span class="token keyword">BLOB</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span><br>    integrity_hash    <span class="token keyword">TEXT</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span><br>    server_seq        <span class="token keyword">INTEGER</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span><br>    <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span>sync_id<span class="token punctuation">,</span> id<span class="token punctuation">)</span><br><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> sync_cursors <span class="token punctuation">(</span><br>    sync_id   <span class="token keyword">TEXT</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token keyword">REFERENCES</span> accounts<span class="token punctuation">(</span>sync_id<span class="token punctuation">)</span> <span class="token keyword">ON</span> <span class="token keyword">DELETE</span> <span class="token keyword">CASCADE</span><span class="token punctuation">,</span><br>    next_seq  <span class="token keyword">INTEGER</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token number">1</span><br><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div><p>Here is what the server knows and does not know:</p><p><img src="/images/server_see.png" alt="What the server can and cannot see"></p><p>Even the column named <code>sync_id</code> in the database is misleading — it stores the auth token, not the actual sync ID. The naming was an early decision and I have to change it to be more accurate.</p><h3>Account creation flow</h3><p>When a user taps &quot;Generate Sync ID&quot; in the app, the following sequence happens:</p><ol><li>The client generates a sync ID locally: <code>wl-a1b2c3d4e5f6a7b8c9d0</code></li><li>The client computes <code>SHA-256(&quot;auth:&quot; + syncId)</code> to get the auth token</li><li>The client sends a <code>POST /api/v1/accounts</code> with the auth token in the request body</li><li>The server generates 16 random bytes as the salt, stores the auth token and salt, and returns the salt to the client</li><li>The client computes <code>SHA-256(&quot;crypto:&quot; + syncId)</code> to get the crypto seed</li><li>The client runs PBKDF2 with the crypto seed and server salt to derive the AES-256-GCM key</li><li>Sync is ready</li></ol><p><img src="/images/device_a.png" alt="Account creation flow"></p><p>The server enforces rate limiting on account creation to prevent abuse. But there is no CAPTCHA, no email verification, no OAuth flow. The auth token is self-authenticating — if you can produce it, you are the account owner.</p><h3>Multi-device sync</h3><p>When device B enters the same sync ID, the flow is:</p><ol><li>The client computes the auth token from the entered sync ID</li><li>The client calls <code>GET /api/v1/accounts/validate</code> with the auth token as an <code>X-Auth-Token</code> header</li><li>The server looks up the auth token, confirms the account exists, and returns the salt</li><li>The client derives the same encryption key (same sync ID + same salt = same key)</li><li>The client performs a full bidirectional sync via <code>POST /api/v1/sync/full</code></li></ol><p>The full sync sends all local entries (encrypted) to the server and receives all server entries back. Both sides merge using last-write-wins on the <code>updatedAt</code> timestamp.</p><p><img src="/images/device_b.png" alt="Multi-device sync"></p><p>This is the crucial property: because key derivation is deterministic, any device with the same sync ID and salt produces the same encryption key. The server does not coordinate key exchange. There is no key escrow. The key exists only in browser memory, derived fresh on each session.</p><h2>Random questions</h2><p>Going through this exercise, I had some random questions. So you might have them too:</p><h3>Is SHA-256 deterministic?</h3><p>Yes, absolutely. That is the entire reason this works.</p><p>SHA-256 is a deterministic hash function. The same input always produces the same output, on any device, in any browser, forever. There is no randomness involved in hashing.</p><p>So when Device B enters <code>wl-a1b2c3d4e5f6a7b8c9d0</code>:</p><div class="code-block-container"><button class="copy-code-button" aria-label="Copy snippet"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg></button><pre><code>Device A:  SHA-256(&quot;auth:&quot; + &quot;wl-a1b2c3d4e5f6a7b8c9d0&quot;)  →  7f3a8b...
Device B:  SHA-256(&quot;auth:&quot; + &quot;wl-a1b2c3d4e5f6a7b8c9d0&quot;)  →  7f3a8b...
                                                                ^^^^^^^^
                                                            identical every time
</code></pre></div><p>Same input, same output. Device B sends 7f3a8b... as the X-Auth-Token header, the server looks it up, finds the account, returns the salt. Then:</p><div class="code-block-container"><button class="copy-code-button" aria-label="Copy snippet"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg></button><pre><code>Device A:  SHA-256(&quot;crypto:&quot; + &quot;wl-a1b2c3d4e5f6a7b8c9d0&quot;)  →  e9c1f2...
Device B:  SHA-256(&quot;crypto:&quot; + &quot;wl-a1b2c3d4e5f6a7b8c9d0&quot;)  →  e9c1f2...
                                                                ^^^^^^^^
                                                            identical every time
</code></pre></div><p>Same crypto seed + same salt (from server) → PBKDF2 is also deterministic → same AES-256-GCM key on both devices.</p><p>The only randomness in the entire crypto pipeline is:</p><ol><li>The sync ID generation (once, on Device A)</li><li>The salt generation (once, on the server)</li><li>The IV for each encryption call (random 12 bytes every time, which is why re-encrypting the same entry produces different ciphertext)</li></ol><p>Everything else is deterministic by design — that is what makes multi-device work without any key exchange protocol.</p><h3>And why can't the server use the salt and auth token to reverse the sync ID?</h3><p>Because SHA-256 is a one-way function. It only works in one direction.</p><div class="code-block-container"><button class="copy-code-button" aria-label="Copy snippet"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg></button><pre><code>&quot;auth:&quot; + &quot;wl-a1b2c3d4e5f6a7b8c9d0&quot;  →  SHA-256  →  7f3a8b...
</code></pre></div><p>There is no SHA-256-reverse function. Given 7f3a8b..., there is no mathematical operation that produces the input. This is not encryption (which is reversible with a key) — it is hashing (which destroys information). The 256-bit output is a fixed-size digest of arbitrary-length input. Many possible inputs map to the same output, so the mapping is inherently irreversible.</p><p>The salt does not help either. The salt is used later in the pipeline, in a completely separate step:</p><div class="code-block-container"><button class="copy-code-button" aria-label="Copy snippet"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg></button><pre><code>syncId
  │
  ├── SHA-256(&quot;auth:&quot; + syncId)   → auth token     ← server has this
  │
  └── SHA-256(&quot;crypto:&quot; + syncId) → crypto seed    ← server does NOT have this
        │
        └── PBKDF2(cryptoSeed, salt, 100k) → key   ← salt is used HERE
</code></pre></div><p>The salt participates in PBKDF2 key derivation from the crypto seed, not from the auth token. The server has the auth token and the salt, but these two values never interact in the derivation chain. They are on separate branches. The salt is useless without the crypto seed, and the crypto seed is a different hash that the server never receives.</p><p>So the server would need to brute-force the sync ID: guess a value, hash it with <code>&quot;auth:&quot;</code> prefix, check if it matches the stored auth token. With 80 bits of entropy (10 random bytes), that is 2⁸⁰ ≈ 1.2 × 10²⁴ guesses. At a billion hashes per second, that takes about 38 million years.</p><h2>Final thoughts</h2><p>I am quite happy with how it turned out. In the beginning, everything really worked like magic. I could click on a &quot;generate sync ID&quot; button, it created one and started syncing immediately. I copy/pasted the same id to my other browser session, and less than a second later, I saw the same entries. This whole process made me really curious if I am ever able to implement a truly &quot;zero-knowledge&quot; sync someday.</p><p>And for the syncing itself: There were enough gotchas and race conditions, which I have to write another day about.</p></main><aside class="post__aside"><nav class="post__pagination"><a href="/posts/my-setup-for-an-ad-free-life-(featuring-adguard-home)/"><span>My setup for an ad-free life (featuring AdGuard Home)</span> <span>→</span></a></nav></aside></article></main><footer class="footer"><div class="footer__content"><ul class="hero__social-links"><li><a href="https://github.com/gruberb" target="_blank" rel="noopener noreferrer">GitHub</a></li><li><a href="https://www.linkedin.com/in/bastiangruber/" target="_blank" rel="noopener noreferrer">LinkedIn</a></li><li><a href="https://hachyderm.io/@bastian" target="_blank" rel="noopener noreferrer">Mastodon</a></li><li><a href="https://bsky.app/profile/bastiangruber.bsky.social" target="_blank" rel="noopener noreferrer">Bluesky</a></li><li><a href="https://rustwebdevelopment.com" target="_blank" rel="noopener noreferrer">Book</a></li><li><a href="/feed.xml" target="_blank" rel="noopener noreferrer">RSS</a></li></ul></div></footer></div><div class="table-of-contents" id="table-of-contents"><h3>Contents</h3><ul class="toc-list" id="toc-list"></ul></div><button class="toc-toggle" id="toc-toggle" aria-label="Toggle table of contents"><svg viewBox="0 0 24 24"><path d="M3 9h14V7H3v2zm0 4h14v-2H3v2zm0 4h14v-2H3v2zm16 0h2v-2h-2v2zm0-10v2h2V7h-2zm0 6h2v-2h-2v2z"/></svg></button><script src="/assets/main.31b965927297922e1170.js"></script><script>const copySvg = `
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
      <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
    </svg>
    `;
    const checkSvg = `
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-check-icon lucide-check"><path d="M20 6 9 17l-5-5"/></svg>
    `;

    document.querySelectorAll(".copy-code-button").forEach(btn => {
        // initialize with copy icon
        btn.innerHTML = copySvg;

        btn.addEventListener("click", () => {
            let code = btn.nextElementSibling.querySelector("code");
            if (!code) return;

            navigator.clipboard.writeText(code.innerText).then(() => {
            // swap to check
            btn.innerHTML = checkSvg;

            // back to copy icon after 2s
            setTimeout(() => {
                btn.innerHTML = copySvg;
            }, 2000);
            });
        });
    });</script></body></html>